<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Registration - AI Appointment System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; min-height: 100vh; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem 0; text-align: center; }
        .nav-buttons { position: absolute; top: 1rem; right: 2rem; }
        .nav-btn { background: rgba(255,255,255,0.2); color: white; padding: 0.5rem 1rem; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; text-decoration: none; margin-left: 0.5rem; transition: all 0.3s; }
        .nav-btn:hover { background: rgba(255,255,255,0.3); }
        .container { max-width: 600px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); overflow: hidden; }
        .card-header { background: #f8f9fa; padding: 1.5rem 2rem; border-bottom: 1px solid #e9ecef; text-align: center; }
        .card-body { padding: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151; }
        .form-input { width: 100%; padding: 0.75rem; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 1rem; transition: border-color 0.3s; }
        .form-input:focus { outline: none; border-color: #667eea; }
        .form-input.error { border-color: #ef4444; }
        .btn { width: 100%; padding: 0.75rem 1rem; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: all 0.3s; }
        .btn:hover { background: #5a67d8; transform: translateY(-1px); }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        .message { padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: none; white-space: pre-line; }
        .message.success { background: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
        .message.error { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        .patient-id { font-weight: bold; font-family: 'Courier New', monospace; background: #f0fdf4; padding: 0.75rem 1rem; border-radius: 6px; border: 2px solid #22c55e; display: inline-block; margin: 0.5rem 0; font-size: 1.2rem; letter-spacing: 2px; cursor: pointer; user-select: all; transition: all 0.2s; }
        .patient-id:hover { background: #dcfce7; border-color: #16a34a; transform: scale(1.02); }
        .copy-instruction { font-size: 0.9rem; color: #059669; font-style: italic; }
        .required { color: #ef4444; }
        .form-help { font-size: 0.875rem; color: #6b7280; margin-top: 0.25rem; }
        .back-link { text-align: center; margin-top: 1.5rem; }
        .back-link a { color: #667eea; text-decoration: none; }
        .back-link a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="header">
        <div class="nav-buttons">
            <a href="/" class="nav-btn">‚Üê Dashboard</a>
            <a href="/chat" class="nav-btn">üí¨ Chat</a>
        </div>
        <h1>üè• Patient Registration</h1>
        <p>Register as a new patient to book appointments</p>
    </div>

    <div class="container">
        <div class="card">
            <div class="card-header">
                <h2>New Patient Registration</h2>
                <p style="margin-top: 0.5rem; color: #6b7280;">Please fill in your information below</p>
            </div>
            <div class="card-body">
                <div id="registration-message" class="message"></div>
                
                <form id="registration-form">
                    <div class="form-group">
                        <label for="patient-name" class="form-label">
                            Full Name <span class="required">*</span>
                        </label>
                        <input 
                            type="text" 
                            id="patient-name" 
                            name="name"
                            class="form-input" 
                            required 
                            placeholder="Enter your full name"
                            autocomplete="name"
                        >
                        <div class="form-help">Enter your first and last name as you'd like it to appear in your appointments</div>
                    </div>

                    <div class="form-group">
                        <label for="patient-age" class="form-label">
                            Age
                        </label>
                        <input 
                            type="number" 
                            id="patient-age" 
                            name="age"
                            class="form-input" 
                            value="35" 
                            min="1" 
                            max="120"
                            placeholder="Enter your age"
                        >
                        <div class="form-help">Your age helps us provide appropriate medical care</div>
                    </div>

                    <div class="form-group">
                        <label for="patient-condition" class="form-label">
                            Reason for Visit / Medical Condition
                        </label>
                        <input 
                            type="text" 
                            id="patient-condition" 
                            name="condition"
                            class="form-input" 
                            placeholder="e.g., General consultation, Follow-up visit, Specific concern"
                        >
                        <div class="form-help">Briefly describe why you need to see a doctor (optional)</div>
                    </div>

                    <button type="submit" class="btn" id="register-btn">
                        Register as Patient
                    </button>
                </form>

                <div class="back-link">
                    <a href="/">‚Üê Back to Dashboard</a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Prevent multiple simultaneous registrations
        let isRegistering = false;

        // Handle registration form submission
        async function handleRegistration(event) {
            event.preventDefault();
            
            // Prevent double submissions
            if (isRegistering) {
                return;
            }
            
            const submitBtn = document.getElementById('register-btn');
            const messageDiv = document.getElementById('registration-message');
            
            // Get form data
            const name = document.getElementById('patient-name').value.trim();
            const age = parseInt(document.getElementById('patient-age').value) || 35;
            const condition = document.getElementById('patient-condition').value.trim() || 'General consultation';
            
            // Clear previous messages
            messageDiv.style.display = 'none';
            
            // Validate name
            if (!name) {
                showMessage('Please enter your full name.', 'error');
                document.getElementById('patient-name').classList.add('error');
                return;
            }
            
            // Clear error styling
            document.getElementById('patient-name').classList.remove('error');
            
            // Set registration flag and disable submit button
            isRegistering = true;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Registering...';
            
            try {
                const response = await fetch('/api/patients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name, age, condition })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    // Show success message using the correct message div
                    const messageDiv = document.getElementById('registration-message');
                    messageDiv.innerHTML = `
                        <strong>Welcome ${name}!</strong> You have been successfully registered.<br><br>
                        üÜî <strong>Your Patient ID:</strong><br>
                        <div class="patient-id" id="patient-id-display">${result.patient_id}</div>
                        <div class="copy-instruction">üí° Click the ID above to select it for easy copying</div><br>
                        <strong>Important:</strong> Please copy and save this ID - you'll need it to book appointments.<br><br>
                        <div id="redirect-countdown">This page will redirect to the homepage in 20 seconds...</div>
                    `;
                    messageDiv.className = 'message success';
                    messageDiv.style.display = 'block';
                    
                    // Make patient ID clickable to select text
                    document.getElementById('patient-id-display').addEventListener('click', function() {
                        const range = document.createRange();
                        range.selectNode(this);
                        window.getSelection().removeAllRanges();
                        window.getSelection().addRange(range);
                    });
                    
                    // Clear form
                    document.getElementById('registration-form').reset();
                    document.getElementById('patient-age').value = '35';
                    
                    // Add countdown timer
                    let countdown = 20;
                    const countdownTimer = setInterval(() => {
                        countdown--;
                        const countdownElement = document.getElementById('redirect-countdown');
                        if (countdownElement) {
                            countdownElement.textContent = `This page will redirect to the homepage in ${countdown} seconds...`;
                        }
                        
                        if (countdown <= 0) {
                            clearInterval(countdownTimer);
                            window.location.href = '/';
                        }
                    }, 1000);
                    
                    // DON'T re-enable button after successful registration
                    return;
                    
                } else {
                    showMessage(result.message || 'Registration failed. Please try again.', 'error');
                }
                
            } catch (error) {
                showMessage('Network error: Unable to connect to the server. Please try again.', 'error');
                console.error('Registration error:', error);
            } finally {
                // Only re-enable button for errors, not for successful registration
                // (successful registration already returned early)
                isRegistering = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Register as Patient';
            }
        }

        // Show messages to user
        function showMessage(message, type) {
            const messageDiv = document.getElementById('registration-message');
            messageDiv.textContent = message;
            messageDiv.className = `message ${type}`;
            messageDiv.style.display = 'block';
            
            // Scroll to message
            messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Setup form handler
            document.getElementById('registration-form').addEventListener('submit', handleRegistration);
            
            // Focus on name field
            document.getElementById('patient-name').focus();
            
            // Auto-clear error styling when user starts typing
            document.getElementById('patient-name').addEventListener('input', function() {
                this.classList.remove('error');
            });
        });
    </script>
</body>
</html>